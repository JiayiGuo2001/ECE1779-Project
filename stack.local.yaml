services:
    postgres:
        image: postgres:latest
        environment:
            POSTGRES_DB: ticket_tracker
            POSTGRES_USER_FILE: /run/secrets/db_user
            POSTGRES_PASSWORD_FILE: /run/secrets/db_password
        volumes:
            - $HOME/Documents/Schoolwork/MEng/ECE1779/Project/postgres_data:/var/lib/postgresql
            - $HOME/Documents/Schoolwork/Meng/ECE1779/Project/ECE1779-Project/db/init.sql:/docker-entrypoint-initdb.d/init.sql
        networks:
            - app_network
        secrets:
            - db_user
            - db_password

    ticket-tracker-app:
        image: ticket-tracker-api:latest
        environment:
            DB_HOST: postgres
            DB_PORT: 5432
            DB_NAME: ticket_tracker
            PORT: 3000
        networks:
            - app_network
        secrets:
            - db_user
            - db_password
            - email_user
            - email_password
            - gmail_client_id
            - gmail_client_secret
            - gmail_refresh_token
        deploy:
            replicas: 2

    nginx:
        image: nginx:alpine
        ports:
            - "80:80"
            - "443:443"
        volumes:
            - ../nginx/nginx.conf:/etc/nginx/nginx.conf:ro
            - ../ssl:/etc/ssl:ro
        networks:
            - app_network

networks:
    app_network:
        external: true

secrets:
    db_user:
        external: true
    db_password:
        external: true
    email_user:
        external: true
    email_password:
        external: true
    gmail_client_id:
        external: true
    gmail_client_secret:
        external: true
    gmail_refresh_token:
        external: true
